<!DOCTYPE HTML>
<html>
<head>
  <!script type="text/javascript" src="mini_require.js"></script>
  <script type="text/javascript" src="ace.js"></script>
  <script type="text/javascript" src="auto_brace_insert.js"></script>
  <script type="text/javascript" src="tex_highlight_rules.js"></script>
  <script type="text/javascript" src="r_highlight_rules.js"></script>
  <script type="text/javascript" src="r_matching_brace_outdent.js"></script>
  <script type="text/javascript" src="r.js"></script>
  <script type="text/javascript" src="r_code_model.js"></script>
  <script type="text/javascript" src="r_scope_tree.js"></script>
  <style type="text/css">
  pre {
    margin-bottom: 30px;
    padding: 3px;
    border: 1px solid #999;
  }
  </style>
</head>
<body>

<h2>Interactive Tester</h2>
<div id="editor" style="width: 600px; height: 200px; border: 1px solid #999"></div>

<h2 style="margin-top: 250px">Automated Tests</h2>
<p>Passed: <span id="passed"></span>, Failed: <span id="failed"></span></p>
<ol id="testcontainer" style="display: none;">
<li><pre data-expected="2">
doPlot &lt;- function()
</pre></li>
<li><pre data-expected="2">
doPlot &lt;- function() {
</pre></li>
<li><pre data-expected="4">
  doPlot &lt;- function() {
</pre></li>
<li><pre data-expected="2">
doPlot &lt;- function()
{
</pre></li>
<li><pre data-expected="2">
plot(
</pre></li>
<li><pre data-expected="2" data-expected-vertical-args="5">
plot(x,
</pre></li>
<li><pre data-expected="2" data-expected-vertical-args="5">
plot(x,
     y,
</pre></li>
<li><pre data-expected="7">
plot(x,
     c(foo,
</pre></li>
<li><pre data-expected="2" data-expected-vertical-args="5">
plot(x,
     c(foo,
       bar),
</pre></li>
<li><pre data-expected="2">
plot(
  x,
  c(foo,
    bar),
</pre></li>
<li><pre data-expected="0">
plot(x, c(foo, bar))
</pre></li>
<li><pre data-expected="0">
plot(
  x, c(foo, bar))
</pre></li>
<li><pre data-expected="0">
plot(x,
     c(foo, bar))
</pre></li>
<li><pre data-expected="2">
  plot(x,
       c(foo, bar))
</pre></li>
<li><pre data-expected="4">
  if (foo())
</pre></li>
<li><pre data-expected="4">
  if (foo())
    bar
  else
</pre></li>
<li><pre data-expected="4">
  if (foo())
    bar
  else
# annoyingly placed comment
</pre></li>
<li><pre data-expected="0">
if (foo())
  bar
else NULL
</pre></li>
<li><pre data-expected="4">
  for (i = 0;
       i &lt; (20 * intervals);
       i += 1)
                  # annoyingly placed comment
</pre></li>
<li><pre data-expected="4">
function() {
  for (i = 0;
       i &lt; (20 * intervals);
       i += 1)
</pre></li>
<li><pre data-expected="2">
function() {
  for (i = 0;
       i &lt; (20 * intervals);
       i += 1) NULL
</pre></li>
<li><pre data-expected="2">
function() {
  for (i = 0;
       i &lt; (20 * intervals);
       i += 1) ()
</pre></li>
<li><pre data-expected="4">
function() {
  for (i = 0;
       i &lt; (20 * intervals);
       i += 1)
  {
</pre></li>
<li><pre data-expected="4">
function() {
  for (i = 0;
       i &lt; (20 * intervals);
       i += 1) {
</pre></li>
<li><pre data-expected="4">
  if (x) {
</pre></li>
<li><pre data-expected="4">
  if (foo(
</pre></li>
<li><pre data-expected="6">
  if (foo(
        bar),
</pre></li>
<li><pre data-expected="2">
  while (foo())
    NULL
</pre></li>
<li><pre data-expected="4">
  while (foo())
  {
</pre></li>
<li><pre data-expected="2">
  # Invalid parse tree
  while (foo())
  {
    foo (()
  }
</pre></li>
<li><pre data-expected="2">
  repeat
    foo()
</pre></li>
<li><pre data-expected="4">
function() {
  repeat
</pre></li>
<li><pre data-expected="4">
function() {
  repeat {
</pre></li>
<li><pre data-expected="2">
5 *
</pre></li>
<li><pre data-expected="2">
# One expression continued over more than two lines
5 ~
  5 +
</pre></li>
<li><pre data-expected="4">
else
  5 +
</pre></li>
<li><pre data-expected="4">
if (foo())
  5 +
</pre></li>
<li><pre data-expected="2">
xyplot(ysim ~ xsim) +
  layer(panel.ablineq(lm(y ~ x), r.sq = TRUE, rot = TRUE,
                      at = 0.8, pos = 3), style = 1) +
</pre></li>
<li><pre data-expected="2">
verylongfunction(a=1,
  b=2, 
</pre></li>
<li><pre data-expected="2">
verylongfunction(a=1,
  b=2 + 3 + 
    4, 
</pre></li>
<li><pre data-expected="2">
verylongfunction(a=1,
  b="Multi line
strings are evil" 
</pre></li>
<li><pre data-expected="2">
verylongfunction(a=1,
  "Single line strings are OK"
</pre></li>
<li><pre data-expected="2" data-expected-vertical-args="17">
verylongfunction(a=1,
</pre></li>
<li><pre data-expected="2" data-expected-vertical-args="17">
verylongfunction("Multi 
line strings are evil"
</pre></li>
<li><pre data-expected="2" data-expected-vertical-args="17">
verylongfunction(x=1


</pre></li>
<li><pre data-expected="2" data-expected-vertical-args="3">
verylongfunction(x=1
   # I'm about to document an arg
</pre></li>
</ol>

<script type="text/javascript">
var RCodeModel = require('mode/r_code_model').RCodeModel;
var Document = require('ace/document').Document;
var RMode = require('mode/r').Mode;
require('mode/auto_brace_insert').setInsertMatching(true);

function doIndentTest(el, state) {
  var doc = new Document('');
  var mode = new RMode(false, doc);
  var rCodeModel = new RCodeModel(doc, mode.$tokenizer);

  doc.insert({row:0, column:0}, (el.innerText || el.textContent).trimRight());

  var indent = rCodeModel.getNextLineIndent(doc.getLength() - 1,
                                            doc.getLine(doc.getLength() - 1),
                                            "start",
                                            "  ",
                                            2);
  el.appendChild(document.createTextNode(indent + "|"));
  var attrName = "data-expected"; 
  if (state.length > 0 && 
      el.getAttribute(attrName + "-" + state)) 
  {
     attrName += ("-" + state);
  }
  var expected = el.getAttribute(attrName);
  if (expected == indent.length + "")
  {
    el.style.backgroundColor = '#BFB';
    return true;
  }
  else
  {
    el.style.backgroundColor = 'pink';
    return false;
  }
}

var test = document.getElementById("runme");
var container = document.getElementById("testcontainer");
var passed = 0, failed = 0;
var states = [ "", "vertical-args" ];
for (var i = 0; i < states.length; i++) 
{
   // Set up the state to be tested
   require('mode/r_code_model').setVerticallyAlignFunctionArgs(
      states[i] === "vertical-args");
   // Clone the tests for the new state
   var testnode = container.cloneNode(true);
   var header = document.createElement("h2");
   header.innerText = "Test " + i + (
      states[i].length > 0 ? 
         ": " + states[i] : 
         "");
   container.parentNode.appendChild(header);
   container.parentNode.appendChild(testnode);
   testnode.style.display = "block";
   pres = testnode.getElementsByTagName("pre");
   for (var j = 0; j < pres.length; j++)
   {
     if (!test)
     {
       if (doIndentTest(pres[j], states[i]))
         passed++;
       else
         failed++;
     }
     else
     {
       if (pres[j] != test)
         pres[j].style.display = 'none';
     }
   }
}
if (test)
{
  if (doIndentTest(test))
    passed++;
  else
    failed++;
}

document.getElementById('passed').innerText = passed;
document.getElementById('failed').innerText = failed;

var editor = ace.edit('editor');
editor.renderer.setHScrollBarAlwaysVisible(false);
editor.setHighlightActiveLine(false);
var RMode = require('mode/r').Mode;
editor.getSession().setMode(new RMode(false, editor.getSession().getDocument()));
//editor.getSession().setUseSoftTabs(false);
</script>
</body>
</html>
